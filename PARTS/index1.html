<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARTS 提示詞產生器</title>
    
    <!-- Load Tailwind CSS first -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind AFTER it has been loaded -->
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-enter {
            animation: fadeIn 0.3s ease-out;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        /* Custom scrollbar for better aesthetics */
        textarea::-webkit-scrollbar,
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        /* Light mode scrollbar */
        html:not(.dark) textarea::-webkit-scrollbar-track,
        html:not(.dark) .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; /* bg-slate-100 */
        }
        html:not(.dark) textarea::-webkit-scrollbar-thumb,
        html:not(.dark) .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* bg-slate-400 */
            border-radius: 20px;
            border: 2px solid #f1f5f9;
        }
        /* Dark mode scrollbar */
        html.dark textarea::-webkit-scrollbar-track,
        html.dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
        }
        html.dark textarea::-webkit-scrollbar-thumb,
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* bg-gray-600 */
            border-radius: 20px;
            border: 2px solid #2d3748; /* bg-gray-800 */
        }
        .example-btn {
            transition: all 0.2s ease-in-out;
        }
        .example-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        html.dark .example-btn:hover {
             box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
    </style>
    
    <!-- SCRIPT TO PREVENT FLASH OF INCORRECT THEME (FOUC) -->
    <script>
        // Placed in the head to run before the body renders
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-white flex items-center justify-center min-h-screen p-4 transition-colors duration-300">

    <div class="w-full max-w-4xl mx-auto relative">
        <!-- CONTROL BUTTONS: Reordered as per request -->
        <div class="absolute top-0 right-0 flex items-center space-x-2">
             <button id="example-toggle-btn" type="button" title="顯示/隱藏範例庫" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-xl p-2.5 transition-colors duration-200">
                💡
            </button>
            <button id="theme-toggle" type="button" title="切換深淺色主題" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 transition-colors duration-200">
                <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM3 11a1 1 0 100 2h1a1 1 0 100-2H3z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
            <button id="version-btn" type="button" title="版本資訊" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-xl p-2.5 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.381-2.29-.287a.5.5 0 0 1-.497-.534l.738-3.468a.5.5 0 0 1 .534-.497zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                </svg>
            </button>
        </div>
        
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">
                PARTS 提示詞產生器
            </h1>
            <p class="text-gray-600 dark:text-gray-400 mt-3 text-lg">透過結構化框架，引導你寫出高品質的 Gemini 提示詞。</p>
        </header>

        <!-- Main Content Area -->
        <main class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm p-6 md:p-8 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700">
            
            <!-- NEW: Example Library (now hidden by default) -->
            <section id="example-library" class="mb-8 hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">💡 範例庫 (點擊以載入)</h2>
                <div id="example-buttons-container" class="flex flex-wrap gap-3">
                    <!-- Example buttons will be injected here by JavaScript -->
                </div>
            </section>

            <!-- Input Grid for PARTS model -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- P: Persona -->
                <div class="flex flex-col space-y-2">
                    <label for="persona" class="text-lg font-semibold text-purple-600 dark:text-purple-300">P (Persona) - 角色設定</label>
                    <p class="text-sm text-gray-500 dark:text-gray-400">設定 Gemini 的專家角色與回應風格。</p>
                    <textarea id="persona" rows="3" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-300 placeholder-gray-400 dark:placeholder-gray-500" placeholder="例如：你是一位經驗豐富的國小五年級國語老師。"></textarea>
                </div>

                <!-- A: Act -->
                <div class="flex flex-col space-y-2">
                    <label for="act" class="text-lg font-semibold text-pink-600 dark:text-pink-300">A (Act) - 任務指令</label>
                    <p class="text-sm text-gray-500 dark:text-gray-400">使用明確的動詞，告訴 Gemini 要執行的具體動作。</p>
                    <textarea id="act" rows="3" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition duration-300 placeholder-gray-400 dark:placeholder-gray-500" placeholder="例如：請設計一份關於記敘文寫作的學習單。"></textarea>
                </div>

                <!-- R: Recipient -->
                <div class="flex flex-col space-y-2">
                    <label for="recipient" class="text-lg font-semibold text-red-600 dark:text-red-300">R (Recipient) - 目標對象</label>
                    <p class="text-sm text-gray-500 dark:text-gray-400">指明產出內容是為誰設計的，例如學生的年級或能力程度。</p>
                    <textarea id="recipient" rows="3" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition duration-300 placeholder-gray-400 dark:placeholder-gray-500" placeholder="例如：這份學習單是給寫作能力中等的學生使用的。"></textarea>
                </div>

                <!-- T: Topic -->
                <div class="flex flex-col space-y-2">
                    <label for="topic" class="text-lg font-semibold text-orange-600 dark:text-orange-300">T (Topic) - 主題內容</label>
                    <p class="text-sm text-gray-500 dark:text-gray-400">提供任務所需的核心主題、文本或相關背景資料。</p>
                    <textarea id="topic" rows="3" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-300 placeholder-gray-400 dark:placeholder-gray-500" placeholder="例如：學習單應包含如何運用五感描寫的練習。"></textarea>
                </div>

                 <!-- S: Structure -->
                 <div class="col-span-1 md:col-span-2 flex flex-col space-y-2">
                    <label for="structure" class="text-lg font-semibold text-teal-600 dark:text-teal-300">S (Structure) - 格式要求</label>
                    <p class="text-sm text-gray-500 dark:text-gray-400">指定輸出的格式，如表格、條列式、特定段落結構等。</p>
                    <textarea id="structure" rows="3" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition duration-300 placeholder-gray-400 dark:placeholder-gray-500" placeholder="例如：請以包含「學習目標」、「引導語」、「學生作答區」三部分的格式呈現。"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex justify-center items-center gap-4">
                <button id="generate-btn" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out">
                    產生優化提示詞 ✨
                </button>
                 <button id="load-history-btn" title="從Google試算表讀取紀錄" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-600 dark:text-gray-300 font-semibold py-2 px-4 rounded-full text-sm transition-colors duration-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock-history" viewBox="0 0 16 16">
                        <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zM13.5 8a5.5 5.5 0 0 1-10.998 0H13.5zM8 15a7 7 0 0 0 7-7h-1a6 6 0 0 1-6 6v1zM8 6.5V13H7V6.5h1z"/>
                        <path d="M5.050 4.086 7.929 6.965a.5.5 0 0 0 .707 0l2.879-2.879a.5.5 0 0 0-.707-.707l-2.525 2.525-2.525-2.525a.5.5 0 0 0-.707.707z"/>
                    </svg>
                    <span>讀取紀錄</span>
                </button>
                <button id="clear-btn" title="清除所有輸入內容" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-600 dark:text-gray-300 font-semibold py-2 px-4 rounded-full text-sm transition-colors duration-300">
                    全部清除
                </button>
            </div>

            <!-- Output Section -->
            <div id="output-section" class="mt-10 space-y-6 hidden">
                <!-- Original Prompt -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-gray-300">原始組合提示詞</h3>
                    <div id="original-prompt" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-4 whitespace-pre-wrap text-gray-600 dark:text-gray-300"></div>
                </div>

                <!-- Optimized Prompt -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">🚀 Gemini 優化後提示詞</h3>
                        <div class="flex items-center space-x-2">
                            <button id="copy-btn" class="hidden bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-300 font-semibold py-1 px-3 rounded-lg text-sm transition-colors duration-200 flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M4 1.5H3a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-8a1 1 0 0 1 1-1h1v-1z"></path>
                                    <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
                                </svg>
                                <span>複製</span>
                            </button>
                             <!-- MOVED AND RESTYLED SAVE BUTTON -->
                            <button id="save-sheet-btn" title="將此提示詞儲存至Google試算表" class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-lg text-sm transition-colors duration-200 flex items-center gap-2">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-arrow-up-fill" viewBox="0 0 16 16">
                                    <path d="M8 2a5.53 5.53 0 0 0-3.594 1.342c-.766.66-1.321 1.52-1.464 2.383C1.266 6.095 0 7.555 0 9.318 0 11.366 1.708 13 3.781 13h8.906C14.502 13 16 11.57 16 9.773c0-1.636-1.242-2.969-2.834-3.194C12.923 3.999 10.69 2 8 2zm2.354 5.146a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2z"/>
                                </svg>
                                <span>儲存</span>
                            </button>
                        </div>
                    </div>
                    <div id="optimized-prompt-container" class="w-full bg-gray-100 dark:bg-gray-900 border-purple-300 dark:border-purple-500/50 border rounded-lg p-4 min-h-[100px] relative">
                        <!-- Loading Spinner -->
                        <div id="loader" class="absolute inset-0 flex items-center justify-center bg-gray-100/50 dark:bg-gray-900/50 rounded-lg">
                            <svg class="animate-spin h-8 w-8 text-purple-500 dark:text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="ml-3 text-gray-600 dark:text-gray-300">Gemini 正在優化中...</span>
                        </div>
                        <!-- Content -->
                        <div id="optimized-prompt" class="whitespace-pre-wrap text-gray-800 dark:text-gray-200"></div>
                    </div>
                </div>

            </div>
        </main>
        
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>v1.8 | 由 Google Gemini 強力驅動 | <a href="https://bit.ly/Aliang" target="_blank" rel="noopener noreferrer" class="hover:underline text-gray-500">丫亮笑長練功坊</a></p>
        </footer>
    </div>

    <!-- Version History Modal -->
    <div id="version-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm hidden">
        <div class="modal-enter bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg m-4">
            <div class="flex justify-between items-center p-5 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">版本更新日誌</h3>
                <button type="button" id="close-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 dark:hover:bg-gray-600 dark:hover:text-white rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
                <ul class="space-y-4 text-gray-600 dark:text-gray-400">
                     <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.8</span> <span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-300">最新</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                             <li>修正「讀取紀錄」時因試算表標題不符，導致顯示 undefined 的問題。</li>
                             <li>強化後端 Apps Script，使其更能應對標題中的多餘空格。</li>
                             <li>優化前端介面，在讀取失敗時提供更友善的提示。</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.7</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>新增客製化錯誤提示視窗，取代所有 `alert()`，解決沙盒環境限制。</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.6</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>新增「讀取紀錄」功能，可從 Google 試算表載入已存提示詞。</li>
                            <li>更新後端 Apps Script 以支援讀取資料。</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.5</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>修復「儲存至試算表」功能因安全限制無法使用的問題。</li>
                            <li>以客製化彈出視窗取代瀏覽器內建的 prompt() 功能。</li>
                             <li>將「儲存」按鈕移至「複製」按鈕右側。</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.4</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>為「儲存至 Google 試算表」功能新增詳細的錯誤診斷機制。</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.3</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>新增「儲存至 Google 試算表」功能。</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.2</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>新增「版本更新日誌」彈出式視窗。</li>
                        </ul>
                    </li>
                     <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.1</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>新增「全部清除」按鈕，可一鍵清空所有輸入框。</li>
                        </ul>
                    </li>
                     <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.0</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>PARTS 提示詞產生器初始版本。</li>
                            <li>核心功能：PARTS 模型輸入、Gemini 優化提示詞、複製結果。</li>
                            <li>深淺色主題切換。</li>
                            <li>可收合的教學範例庫。</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal for Prompt Name -->
    <div id="prompt-name-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm hidden">
        <div class="modal-enter bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm m-4">
            <div class="p-6 text-center">
                <h3 class="mb-5 text-lg font-normal text-gray-600 dark:text-gray-300">請為這組提示詞命名</h3>
                <input type="text" id="prompt-name-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="例如：國語修辭學習單" required>
                <div class="mt-6 flex justify-center gap-4">
                    <button id="cancel-save-btn" type="button" class="py-2.5 px-5 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-purple-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">取消</button>
                    <button id="confirm-save-btn" type="button" class="text-white bg-purple-600 hover:bg-purple-800 focus:ring-4 focus:outline-none focus:ring-purple-300 dark:focus:ring-purple-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">確認儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for Loading History -->
    <div id="history-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm hidden">
        <div class="modal-enter bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl m-4 flex flex-col">
            <div class="flex justify-between items-center p-5 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">讀取已存提示詞</h3>
                <button type="button" id="close-history-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 dark:hover:bg-gray-600 dark:hover:text-white rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div id="history-list" class="p-6 space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar">
                <!-- History items will be injected here -->
                <div id="history-loader" class="flex items-center justify-center py-10">
                    <svg class="animate-spin h-8 w-8 text-purple-500 dark:text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="ml-4 text-gray-600 dark:text-gray-300">正在從 Google 試算表讀取紀錄...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Custom Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm hidden">
        <div class="modal-enter bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm m-4">
            <div class="p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-gray-700">
                    <svg class="h-6 w-6 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                </div>
                <h3 class="mt-5 text-lg font-medium text-gray-900 dark:text-white">發生錯誤</h3>
                <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                    <p id="alert-message">這裡會顯示錯誤訊息。</p>
                </div>
                <div class="mt-6">
                    <button id="close-alert-btn" type="button" class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-purple-600 text-base font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:text-sm">
                        知道了
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // This event listener ensures that the script runs only after the entire HTML document has been loaded and parsed.
        document.addEventListener('DOMContentLoaded', () => {
            
            // ===================================
            // THEME HANDLING SCRIPT
            // ===================================
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
            const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

            const updateThemeIcons = () => {
                if (document.documentElement.classList.contains('dark')) {
                    themeToggleLightIcon.classList.remove('hidden');
                    themeToggleDarkIcon.classList.add('hidden');
                } else {
                    themeToggleLightIcon.classList.add('hidden');
                    themeToggleDarkIcon.classList.remove('hidden');
                }
            };

            // Run on initial page load
            updateThemeIcons();

            themeToggleBtn.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                localStorage.setItem('color-theme', currentTheme);
                updateThemeIcons();
            });

            // ===================================
            // ALERT MODAL SCRIPT
            // ===================================
            const alertModal = document.getElementById('alert-modal');
            const alertMessageEl = document.getElementById('alert-message');
            const closeAlertBtn = document.getElementById('close-alert-btn');

            const showAlert = (message) => {
                // Using \n for newlines in JS strings; convert to <br> for HTML
                alertMessageEl.innerHTML = message.replace(/\n/g, '<br>');
                alertModal.classList.remove('hidden');
            };

            const hideAlert = () => {
                alertModal.classList.add('modal-leave');
                setTimeout(() => {
                    alertModal.classList.add('hidden');
                    alertModal.classList.remove('modal-leave');
                }, 300);
            };

            closeAlertBtn.addEventListener('click', hideAlert);
            alertModal.addEventListener('click', (event) => {
                if(event.target === alertModal) {
                    hideAlert();
                }
            });


            // ===================================
            // VERSION MODAL SCRIPT
            // ===================================
            const versionBtn = document.getElementById('version-btn');
            const versionModal = document.getElementById('version-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');

            const showVersionModal = () => versionModal.classList.remove('hidden');
            const hideVersionModal = () => {
                versionModal.classList.add('modal-leave');
                setTimeout(() => {
                    versionModal.classList.add('hidden');
                    versionModal.classList.remove('modal-leave');
                }, 300); // Match animation duration
            };

            versionBtn.addEventListener('click', showVersionModal);
            closeModalBtn.addEventListener('click', hideVersionModal);
            versionModal.addEventListener('click', (event) => {
                if (event.target === versionModal) {
                    hideVersionModal();
                }
            });
            
            // ===================================
            // PROMPT NAME MODAL SCRIPT
            // ===================================
            const promptNameModal = document.getElementById('prompt-name-modal');
            const promptNameInput = document.getElementById('prompt-name-input');
            const confirmSaveBtn = document.getElementById('confirm-save-btn');
            const cancelSaveBtn = document.getElementById('cancel-save-btn');

            const showPromptNameModal = () => {
                promptNameInput.value = ''; // Clear previous input
                promptNameModal.classList.remove('hidden');
                promptNameInput.focus();
            };
            const hidePromptNameModal = () => {
                promptNameModal.classList.add('modal-leave');
                 setTimeout(() => {
                    promptNameModal.classList.add('hidden');
                    promptNameModal.classList.remove('modal-leave');
                }, 300);
            };

            cancelSaveBtn.addEventListener('click', hidePromptNameModal);
            promptNameModal.addEventListener('click', (event) => {
                if (event.target === promptNameModal) {
                    hidePromptNameModal();
                }
            });


            // ===================================
            // EXAMPLE LIBRARY TOGGLE SCRIPT
            // ===================================
            const exampleToggleBtn = document.getElementById('example-toggle-btn');
            const exampleLibrarySection = document.getElementById('example-library');

            exampleToggleBtn.addEventListener('click', () => {
                const isHidden = exampleLibrarySection.classList.toggle('hidden');
                if (!isHidden) {
                    exampleLibrarySection.classList.add('fade-in');
                }
            });
            
            // ===================================
            // EXAMPLE LIBRARY SCRIPT
            // ===================================
            const examples = [
                {
                    name: "國語：故事續寫",
                    persona: "你是一位充滿創意、擅長引導學生想像力的國小中年級國語老師。",
                    act: "請設計一個故事續寫的學習活動。",
                    recipient: "這份活動是為國小三年級的學生設計的，他們的想像力豐富但寫作結構能力尚待加強。",
                    topic: "故事的開頭是：『在一個下著暴雨的夜晚，小明聽到閣樓傳來一陣奇怪的抓扒聲...』，請引導學生思考接下來可能發生的三種不同情節。",
                    structure: "請用條列式呈現三種情節的發展大綱，每個大綱包含『主角的發現』、『遇到的挑戰』、『意外的结局』三個部分。"
                },
                {
                    name: "數學：生活應用題",
                    persona: "你是一位國小高年級數學老師，擅長將數學與生活情境結合。",
                    act: "請設計一道兩步驟的數學應用題。",
                    recipient: "這道題目是給國小五年級學生練習的，他們已經學會了整數的四則運算。",
                    topic: "情境設定為班級園遊會，班上賺了 1000 元，買了 15 杯單價 30 元的飲料犒賞同學後，剩下的錢要平分給班上 25 位同學。",
                    structure: "請先寫出完整的題目，然後在下方列出計算步驟的引導問題，最後附上正確答案與算式。"
                },
                {
                    name: "自然：植物觀察",
                    persona: "你是一位對自然生態充滿熱情的國小自然老師。",
                    act: "請設計一份植物觀察紀錄單。",
                    recipient: "這份紀錄單是給國小四年級學生在校園進行自然觀察時使用的。",
                    topic: "觀察對象是校園裡的榕樹。紀錄單需要引導學生觀察葉子、樹幹、氣根的特徵。",
                    structure: "請以表格形式呈現，欄位包含「觀察項目」（如：葉子形狀、樹幹顏色、氣根數量）、「觀察紀錄」（讓學生填寫）、「繪圖區」（讓學生畫下來）。"
                },
                {
                    name: "社會：歷史人物",
                    persona: "你是一位擅長說故事的國小社會老師。",
                    act: "請用生動有趣的方式，介紹鄭成功的故事。",
                    recipient: "聽眾是國小四年級的學生，他們對歷史故事感到好奇。",
                    topic: "介紹內容需包含鄭成功是誰、他為什麼要來台灣，以及他對台灣的影響。",
                    structure: "請用第一人稱『我』，也就是你扮演鄭成功的口吻來敘述。內容分成三段，每段不超過150字。"
                },
                 {
                    name: "綜合：班級活動",
                    persona: "你是一位有耐心且善於團隊合作的國小班級導師。",
                    act: "請規劃一個增進班級向心力的期末同樂會活動。",
                    recipient: "活動對象是國小六年級的畢業班學生。",
                    topic: "活動目標是讓學生在畢業前留下美好回憶，並感謝老師與同學。活動時間為一節課40分鐘。",
                    structure: "請提供一份活動流程表，包含時間分配、活動名稱、活動說明、以及需要準備的道具。"
                }
            ];

            const exampleButtonsContainer = document.getElementById('example-buttons-container');
            const personaEl = document.getElementById('persona');
            const actEl = document.getElementById('act');
            const recipientEl = document.getElementById('recipient');
            const topicEl = document.getElementById('topic');
            const structureEl = document.getElementById('structure');

            examples.forEach(example => {
                const button = document.createElement('button');
                button.className = 'example-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 py-2 px-4 rounded-lg font-semibold shadow-sm hover:bg-gray-300 dark:hover:bg-gray-600';
                button.textContent = example.name;
                button.addEventListener('click', () => {
                    // Reset the view by hiding the output section
                    document.getElementById('output-section').classList.add('hidden');

                    personaEl.value = example.persona;
                    actEl.value = example.act;
                    recipientEl.value = example.recipient;
                    topicEl.value = example.topic;
                    structureEl.value = example.structure;
                });
                exampleButtonsContainer.appendChild(button);
            });

            // ===================================
            // MAIN APP SCRIPT
            // ===================================
            // !!! IMPORTANT !!! PASTE YOUR WEB APP URL HERE
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzNEE5foyrgMPSOqsvK50fVgO8npbmV9V6UIwrVuB7myJSy7Rpv9x8vZda7Sc4wRbQr/exec";

            const generateBtn = document.getElementById('generate-btn');
            const clearBtn = document.getElementById('clear-btn');
            const saveSheetBtn = document.getElementById('save-sheet-btn');
            const outputSection = document.getElementById('output-section');
            const originalPromptEl = document.getElementById('original-prompt');
            const optimizedPromptEl = document.getElementById('optimized-prompt');
            const loader = document.getElementById('loader');
            const copyBtn = document.getElementById('copy-btn');
            const loadHistoryBtn = document.getElementById('load-history-btn');


            clearBtn.addEventListener('click', () => {
                personaEl.value = '';
                actEl.value = '';
                recipientEl.value = '';
                topicEl.value = '';
                structureEl.value = '';
                outputSection.classList.add('hidden');
                saveSheetBtn.classList.add('hidden');
            });


            generateBtn.addEventListener('click', async () => {
                const persona = personaEl.value.trim();
                const act = actEl.value.trim();
                const recipient = recipientEl.value.trim();
                const topic = topicEl.value.trim();
                const structure = structureEl.value.trim();
                const parts = [
                    persona ? `角色設定: ${persona}` : '',
                    act ? `任務指令: ${act}` : '',
                    recipient ? `目標對象: ${recipient}` : '',
                    topic ? `主題內容: ${topic}` : '',
                    structure ? `格式要求: ${structure}` : ''
                ];
                const originalPrompt = parts.filter(p => p).join('\n\n');

                if (!originalPrompt) {
                    showAlert('請至少填寫一個欄位！');
                    return;
                }

                outputSection.classList.remove('hidden');
                outputSection.classList.add('fade-in');
                originalPromptEl.textContent = originalPrompt;
                optimizedPromptEl.textContent = '';
                copyBtn.classList.add('hidden');
                saveSheetBtn.classList.add('hidden');
                loader.style.display = 'flex';
                
                const optimizationSystemPrompt = "你是一位提示詞工程專家 (Prompt Engineering Expert)。你的任務是將使用者提供的、由多個部分組合而成的初步提示詞，優化並整合成一個單一、流暢、清晰且高效的完整提示詞。你應該保留所有關鍵訊息和核心意圖，但要以更專業、更結構化的方式重新組織語言，確保AI能夠準確理解並產出最佳結果。直接回傳優化後的提示詞即可，不需要任何額外的前言或結語。";
                const userQueryForApi = `請優化以下這個由PARTS模型各部分組合而成的初步提示詞，將其改寫成一個可以直接使用的、高品質的單一完整提示詞。\n\n---初步提示詞---\n${originalPrompt}`;

                try {
                    const optimizedText = await callGeminiApiWithBackoff(optimizationSystemPrompt, userQueryForApi);
                    optimizedPromptEl.textContent = optimizedText;
                    if (optimizedText && !optimizedText.startsWith("抱歉")) {
                        copyBtn.classList.remove('hidden'); 
                        saveSheetBtn.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('API Error:', error);
                    optimizedPromptEl.textContent = `抱歉，優化過程中發生錯誤。請檢查您的網路連線或稍後再試。\n錯誤訊息: ${error.message}`;
                } finally {
                    loader.style.display = 'none';
                }
            });
            
            // New logic to handle custom modal for saving
            saveSheetBtn.addEventListener('click', () => {
                if (SCRIPT_URL.includes("請在這裡貼上")) {
                    showAlert("錯誤：您尚未在程式碼中設定您的 Google Apps Script 網址！請遵循設定指南完成設定。");
                    return;
                }
                showPromptNameModal();
            });
            
            confirmSaveBtn.addEventListener('click', () => {
                const promptName = promptNameInput.value.trim();
                 if (!promptName) {
                    promptNameInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    promptNameInput.placeholder = "請務必為提示詞命名！";
                    return;
                }
                promptNameInput.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                promptNameInput.placeholder = "例如：國語修辭學習單";
                hidePromptNameModal();
                executeSave(promptName);
            });

            async function executeSave(promptName) {
                const originalButtonText = saveSheetBtn.innerHTML;
                saveSheetBtn.disabled = true;
                saveSheetBtn.innerHTML = `<span>儲存中...</span>`;

                const dataToSave = {
                    promptName: promptName,
                    persona: personaEl.value,
                    act: actEl.value,
                    recipient: recipientEl.value,
                    topic: topicEl.value,
                    structure: structureEl.value,
                    optimizedPrompt: optimizedPromptEl.textContent
                };

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataToSave)
                    });

                    saveSheetBtn.innerHTML = `<span>儲存成功！</span>`;
                    saveSheetBtn.classList.add('bg-blue-600');
                    setTimeout(() => {
                        saveSheetBtn.innerHTML = originalButtonText;
                        saveSheetBtn.disabled = false;
                        saveSheetBtn.classList.remove('bg-blue-600');
                    }, 2000);

                } catch (err) {
                    console.error("Error saving to sheet:", err);
                    saveSheetBtn.innerHTML = `<span>儲存失敗</span>`;
                    saveSheetBtn.classList.add('bg-red-600');
                     setTimeout(() => {
                        saveSheetBtn.innerHTML = originalButtonText;
                        saveSheetBtn.disabled = false;
                        saveSheetBtn.classList.remove('bg-red-600');
                    }, 3000);
                    showAlert(`儲存失敗！\n\n這通常是網路連線或 CORS 跨域政策問題。\n\n1. 請確認您的網路連線正常。\n2. 請再次檢查您的 Apps Script 是否已部署為「任何人」皆可存取。\n3. 請打開瀏覽器主控台 (F12) 查看詳細的紅色錯誤訊息。\n\n錯誤詳情: ${err.message}`);
                }
            }
            
            // ===================================
            // HISTORY MODAL SCRIPT
            // ===================================
            const historyModal = document.getElementById('history-modal');
            const closeHistoryModalBtn = document.getElementById('close-history-modal-btn');
            const historyList = document.getElementById('history-list');
            const historyLoader = document.getElementById('history-loader');

            const showHistoryModal = () => historyModal.classList.remove('hidden');
            const hideHistoryModal = () => {
                historyModal.classList.add('modal-leave');
                setTimeout(() => {
                    historyModal.classList.add('hidden');
                    historyModal.classList.remove('modal-leave');
                }, 300);
            };
            
            loadHistoryBtn.addEventListener('click', async () => {
                if (SCRIPT_URL.includes("請在這裡貼上")) {
                    showAlert("錯誤：您尚未在程式碼中設定您的 Google Apps Script 網址！");
                    return;
                }
                
                showHistoryModal();
                historyLoader.classList.remove('hidden');
                historyList.innerHTML = ''; // Clear previous list but keep the loader
                historyList.appendChild(historyLoader);

                try {
                    // Use GET to fetch data
                    const response = await fetch(SCRIPT_URL);
                    if (!response.ok) {
                        throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();
                    
                    historyLoader.classList.add('hidden');

                    if (data && data.length > 0) {
                        // Data is received in reverse chronological order from script
                        data.forEach(item => {
                            const div = document.createElement('div');
                            const promptName = item.promptName || '（讀取失敗：請檢查試算表標題）';
                            
                            div.className = "p-4 border border-gray-200 dark:border-gray-700 rounded-lg transition-colors";
                             if(item.promptName){
                                div.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700', 'cursor-pointer');
                            } else {
                                div.classList.add('cursor-not-allowed', 'opacity-60');
                            }

                            div.innerHTML = `
                                <h4 class="font-bold text-md text-purple-600 dark:text-purple-400">${promptName}</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 truncate">
                                    ${item.optimizedPrompt || '（無優化後提示詞）'}
                                </p>
                            `;

                            if (item.promptName) {
                                div.addEventListener('click', () => {
                                    personaEl.value = item.persona || '';
                                    actEl.value = item.act || '';
                                    recipientEl.value = item.recipient || '';
                                    topicEl.value = item.topic || '';
                                    structureEl.value = item.structure || '';

                                    // Also populate the output section
                                    const originalPrompt = [
                                        item.persona ? `角色設定: ${item.persona}` : '',
                                        item.act ? `任務指令: ${item.act}` : '',
                                        item.recipient ? `目標對象: ${item.recipient}` : '',
                                        item.topic ? `主題內容: ${item.topic}` : '',
                                        item.structure ? `格式要求: ${item.structure}` : ''
                                    ].filter(p => p).join('\n\n');

                                    outputSection.classList.remove('hidden');
                                    originalPromptEl.textContent = originalPrompt;
                                    optimizedPromptEl.textContent = item.optimizedPrompt || '';
                                    if (item.optimizedPrompt) {
                                        copyBtn.classList.remove('hidden');
                                        saveSheetBtn.classList.remove('hidden');
                                    } else {
                                        copyBtn.classList.add('hidden');
                                        saveSheetBtn.classList.add('hidden');
                                    }
                                    loader.style.display = 'none';
                                    
                                    hideHistoryModal();
                                });
                            }
                            historyList.appendChild(div);
                        });
                    } else {
                        historyList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">您的試算表中沒有任何已存紀錄。</p>`;
                    }

                } catch (error) {
                    console.error("Error fetching history:", error);
                    historyLoader.classList.add('hidden');
                    historyList.innerHTML = `<p class="text-center text-red-500">讀取紀錄失敗！<br>請檢查 Apps Script 部署與權限設定，或查看主控台錯誤。</p>`;
                }
            });
            
            closeHistoryModalBtn.addEventListener('click', hideHistoryModal);
            historyModal.addEventListener('click', (event) => {
                if (event.target === historyModal) {
                    hideHistoryModal();
                }
            });


            copyBtn.addEventListener('click', () => {
                const textToCopy = optimizedPromptEl.textContent;
                if (!textToCopy) return;
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = textToCopy;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                const originalButtonContent = copyBtn.innerHTML;
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
                        <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"></path>
                    </svg>
                    <span>已複製！</span>
                `;
                const btnClasses = ['bg-green-500', 'dark:bg-green-600', 'hover:bg-green-600', 'dark:hover:bg-green-700'];
                copyBtn.classList.add(...btnClasses);
                setTimeout(() => {
                    copyBtn.innerHTML = originalButtonContent;
                    copyBtn.classList.remove(...btnClasses);
                }, 2000);
            });
            
            async function callGeminiApiWithBackoff(systemPrompt, userQuery) {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }] };
                if (systemPrompt) {
                    payload.systemInstruction = { parts: [{ text: systemPrompt }] };
                }
                let attempts = 0;
                const maxAttempts = 5;
                let delay = 1000;
                while (attempts < maxAttempts) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const errorBody = await response.text();
                            throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);
                        }
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            console.warn("API response was successful but contained no text.", result);
                            return "優化後的回應為空，請嘗試調整您的輸入。";
                        }
                    } catch (error) {
                        attempts++;
                        console.warn(`API call attempt ${attempts} failed. Retrying in ${delay}ms...`, error);
                        if (attempts >= maxAttempts) {
                            throw new Error("已達到最大重試次數，API 請求失敗。");
                        }
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
            }
        });
    </script>
</body>
</html>

