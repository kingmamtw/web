<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARTS æç¤ºè©ç”¢ç”Ÿå™¨</title>
    
    <!-- Load Tailwind CSS first -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind AFTER it has been loaded -->
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-enter {
            animation: fadeIn 0.3s ease-out;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        /* Custom scrollbar for better aesthetics */
        textarea::-webkit-scrollbar,
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        /* Light mode scrollbar */
        html:not(.dark) textarea::-webkit-scrollbar-track,
        html:not(.dark) .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; /* bg-slate-100 */
        }
        html:not(.dark) textarea::-webkit-scrollbar-thumb,
        html:not(.dark) .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* bg-slate-400 */
            border-radius: 20px;
            border: 2px solid #f1f5f9;
        }
        /* Dark mode scrollbar */
        html.dark textarea::-webkit-scrollbar-track,
        html.dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
        }
        html.dark textarea::-webkit-scrollbar-thumb,
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* bg-gray-600 */
            border-radius: 20px;
            border: 2px solid #2d3748; /* bg-gray-800 */
        }
        .example-btn {
            transition: all 0.2s ease-in-out;
        }
        .example-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        html.dark .example-btn:hover {
             box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
    </style>
    
    <!-- SCRIPT TO PREVENT FLASH OF INCORRECT THEME (FOUC) -->
    <script>
        // Placed in the head to run before the body renders
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-white flex items-center justify-center min-h-screen p-4 transition-colors duration-300">

    <div class="w-full max-w-4xl mx-auto relative">
        <!-- CONTROL BUTTONS: Reordered as per request -->
        <div class="absolute top-0 right-0 flex items-center space-x-2">
             <button id="example-toggle-btn" type="button" title="é¡¯ç¤º/éš±è—ç¯„ä¾‹åº«" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-xl p-2.5 transition-colors duration-200">
                ğŸ’¡
            </button>
            <button id="theme-toggle" type="button" title="åˆ‡æ›æ·±æ·ºè‰²ä¸»é¡Œ" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 transition-colors duration-200">
                <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM3 11a1 1 0 100 2h1a1 1 0 100-2H3z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
            <button id="version-btn" type="button" title="ç‰ˆæœ¬è³‡è¨Š" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-xl p-2.5 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.381-2.29-.287a.5.5 0 0 1-.497-.534l.738-3.468a.5.5 0 0 1 .534-.497zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                </svg>
            </button>
        </div>
        
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">
                PARTS æç¤ºè©ç”¢ç”Ÿå™¨
            </h1>
            <p class="text-gray-600 dark:text-gray-400 mt-3 text-lg">é€éçµæ§‹åŒ–æ¡†æ¶ï¼Œå¼•å°ä½ å¯«å‡ºé«˜å“è³ªçš„ Gemini æç¤ºè©ã€‚</p>
        </header>

        <!-- Main Content Area -->
        <main class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm p-6 md:p-8 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700">
            
            <!-- NEW: Example Library (now hidden by default) -->
            <section id="example-library" class="mb-8 hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">ğŸ’¡ ç¯„ä¾‹åº« (é»æ“Šä»¥è¼‰å…¥)</h2>
                <div id="example-buttons-container" class="flex flex-wrap gap-3">
                    <!-- Example buttons will be injected here by JavaScript -->
                </div>
            </section>

            <!-- Input Grid for PARTS model -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- P: Persona -->
                <div class="flex flex-col space-y-2">
                    <label for="persona" class="text-lg font-semibold text-purple-600 dark:text-purple-300">P (Persona) - è§’è‰²è¨­å®š</label>
                    <p class="text-sm text-gray-500 dark:text-gray-400">è¨­å®š Gemini çš„å°ˆå®¶è§’è‰²èˆ‡å›æ‡‰é¢¨æ ¼ã€‚</p>
                    <textarea id="persona" rows="3" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-300 placeholder-gray-400 dark:placeholder-gray-500" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä½ç¶“é©—è±å¯Œçš„åœ‹å°äº”å¹´ç´šåœ‹èªè€å¸«ã€‚"></textarea>
                </div>

                <!-- A: Act -->
                <div class="flex flex-col space-y-2">
                    <label for="act" class="text-lg font-semibold text-pink-600 dark:text-pink-300">A (Act) - ä»»å‹™æŒ‡ä»¤</label>
                    <p class="text-sm text-gray-500 dark:text-gray-400">ä½¿ç”¨æ˜ç¢ºçš„å‹•è©ï¼Œå‘Šè¨´ Gemini è¦åŸ·è¡Œçš„å…·é«”å‹•ä½œã€‚</p>
                    <textarea id="act" rows="3" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition duration-300 placeholder-gray-400 dark:placeholder-gray-500" placeholder="ä¾‹å¦‚ï¼šè«‹è¨­è¨ˆä¸€ä»½é—œæ–¼è¨˜æ•˜æ–‡å¯«ä½œçš„å­¸ç¿’å–®ã€‚"></textarea>
                </div>

                <!-- R: Recipient -->
                <div class="flex flex-col space-y-2">
                    <label for="recipient" class="text-lg font-semibold text-red-600 dark:text-red-300">R (Recipient) - ç›®æ¨™å°è±¡</label>
                    <p class="text-sm text-gray-500 dark:text-gray-400">æŒ‡æ˜ç”¢å‡ºå…§å®¹æ˜¯ç‚ºèª°è¨­è¨ˆçš„ï¼Œä¾‹å¦‚å­¸ç”Ÿçš„å¹´ç´šæˆ–èƒ½åŠ›ç¨‹åº¦ã€‚</p>
                    <textarea id="recipient" rows="3" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition duration-300 placeholder-gray-400 dark:placeholder-gray-500" placeholder="ä¾‹å¦‚ï¼šé€™ä»½å­¸ç¿’å–®æ˜¯çµ¦å¯«ä½œèƒ½åŠ›ä¸­ç­‰çš„å­¸ç”Ÿä½¿ç”¨çš„ã€‚"></textarea>
                </div>

                <!-- T: Topic -->
                <div class="flex flex-col space-y-2">
                    <label for="topic" class="text-lg font-semibold text-orange-600 dark:text-orange-300">T (Topic) - ä¸»é¡Œå…§å®¹</label>
                    <p class="text-sm text-gray-500 dark:text-gray-400">æä¾›ä»»å‹™æ‰€éœ€çš„æ ¸å¿ƒä¸»é¡Œã€æ–‡æœ¬æˆ–ç›¸é—œèƒŒæ™¯è³‡æ–™ã€‚</p>
                    <textarea id="topic" rows="3" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-300 placeholder-gray-400 dark:placeholder-gray-500" placeholder="ä¾‹å¦‚ï¼šå­¸ç¿’å–®æ‡‰åŒ…å«å¦‚ä½•é‹ç”¨äº”æ„Ÿæå¯«çš„ç·´ç¿’ã€‚"></textarea>
                </div>

                 <!-- S: Structure -->
                 <div class="col-span-1 md:col-span-2 flex flex-col space-y-2">
                    <label for="structure" class="text-lg font-semibold text-teal-600 dark:text-teal-300">S (Structure) - æ ¼å¼è¦æ±‚</label>
                    <p class="text-sm text-gray-500 dark:text-gray-400">æŒ‡å®šè¼¸å‡ºçš„æ ¼å¼ï¼Œå¦‚è¡¨æ ¼ã€æ¢åˆ—å¼ã€ç‰¹å®šæ®µè½çµæ§‹ç­‰ã€‚</p>
                    <textarea id="structure" rows="3" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition duration-300 placeholder-gray-400 dark:placeholder-gray-500" placeholder="ä¾‹å¦‚ï¼šè«‹ä»¥åŒ…å«ã€Œå­¸ç¿’ç›®æ¨™ã€ã€ã€Œå¼•å°èªã€ã€ã€Œå­¸ç”Ÿä½œç­”å€ã€ä¸‰éƒ¨åˆ†çš„æ ¼å¼å‘ˆç¾ã€‚"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex justify-center items-center gap-4">
                <button id="generate-btn" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out">
                    ç”¢ç”Ÿå„ªåŒ–æç¤ºè© âœ¨
                </button>
                 <button id="load-history-btn" title="å¾Googleè©¦ç®—è¡¨è®€å–ç´€éŒ„" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-600 dark:text-gray-300 font-semibold py-2 px-4 rounded-full text-sm transition-colors duration-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock-history" viewBox="0 0 16 16">
                        <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zM13.5 8a5.5 5.5 0 0 1-10.998 0H13.5zM8 15a7 7 0 0 0 7-7h-1a6 6 0 0 1-6 6v1zM8 6.5V13H7V6.5h1z"/>
                        <path d="M5.050 4.086 7.929 6.965a.5.5 0 0 0 .707 0l2.879-2.879a.5.5 0 0 0-.707-.707l-2.525 2.525-2.525-2.525a.5.5 0 0 0-.707.707z"/>
                    </svg>
                    <span>è®€å–ç´€éŒ„</span>
                </button>
                <button id="clear-btn" title="æ¸…é™¤æ‰€æœ‰è¼¸å…¥å…§å®¹" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-600 dark:text-gray-300 font-semibold py-2 px-4 rounded-full text-sm transition-colors duration-300">
                    å…¨éƒ¨æ¸…é™¤
                </button>
            </div>

            <!-- Output Section -->
            <div id="output-section" class="mt-10 space-y-6 hidden">
                <!-- Original Prompt -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-gray-300">åŸå§‹çµ„åˆæç¤ºè©</h3>
                    <div id="original-prompt" class="w-full bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg p-4 whitespace-pre-wrap text-gray-600 dark:text-gray-300"></div>
                </div>

                <!-- Optimized Prompt -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">ğŸš€ Gemini å„ªåŒ–å¾Œæç¤ºè©</h3>
                        <div class="flex items-center space-x-2">
                            <button id="copy-btn" class="hidden bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-300 font-semibold py-1 px-3 rounded-lg text-sm transition-colors duration-200 flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M4 1.5H3a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-8a1 1 0 0 1 1-1h1v-1z"></path>
                                    <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
                                </svg>
                                <span>è¤‡è£½</span>
                            </button>
                             <!-- MOVED AND RESTYLED SAVE BUTTON -->
                            <button id="save-sheet-btn" title="å°‡æ­¤æç¤ºè©å„²å­˜è‡³Googleè©¦ç®—è¡¨" class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-lg text-sm transition-colors duration-200 flex items-center gap-2">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-arrow-up-fill" viewBox="0 0 16 16">
                                    <path d="M8 2a5.53 5.53 0 0 0-3.594 1.342c-.766.66-1.321 1.52-1.464 2.383C1.266 6.095 0 7.555 0 9.318 0 11.366 1.708 13 3.781 13h8.906C14.502 13 16 11.57 16 9.773c0-1.636-1.242-2.969-2.834-3.194C12.923 3.999 10.69 2 8 2zm2.354 5.146a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2z"/>
                                </svg>
                                <span>å„²å­˜</span>
                            </button>
                        </div>
                    </div>
                    <div id="optimized-prompt-container" class="w-full bg-gray-100 dark:bg-gray-900 border-purple-300 dark:border-purple-500/50 border rounded-lg p-4 min-h-[100px] relative">
                        <!-- Loading Spinner -->
                        <div id="loader" class="absolute inset-0 flex items-center justify-center bg-gray-100/50 dark:bg-gray-900/50 rounded-lg">
                            <svg class="animate-spin h-8 w-8 text-purple-500 dark:text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="ml-3 text-gray-600 dark:text-gray-300">Gemini æ­£åœ¨å„ªåŒ–ä¸­...</span>
                        </div>
                        <!-- Content -->
                        <div id="optimized-prompt" class="whitespace-pre-wrap text-gray-800 dark:text-gray-200"></div>
                    </div>
                </div>

            </div>
        </main>
        
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>v1.8 | ç”± Google Gemini å¼·åŠ›é©…å‹• | <a href="https://bit.ly/Aliang" target="_blank" rel="noopener noreferrer" class="hover:underline text-gray-500">ä¸«äº®ç¬‘é•·ç·´åŠŸåŠ</a></p>
        </footer>
    </div>

    <!-- Version History Modal -->
    <div id="version-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm hidden">
        <div class="modal-enter bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg m-4">
            <div class="flex justify-between items-center p-5 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">ç‰ˆæœ¬æ›´æ–°æ—¥èªŒ</h3>
                <button type="button" id="close-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 dark:hover:bg-gray-600 dark:hover:text-white rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
                <ul class="space-y-4 text-gray-600 dark:text-gray-400">
                     <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.8</span> <span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-300">æœ€æ–°</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                             <li>ä¿®æ­£ã€Œè®€å–ç´€éŒ„ã€æ™‚å› è©¦ç®—è¡¨æ¨™é¡Œä¸ç¬¦ï¼Œå°è‡´é¡¯ç¤º undefined çš„å•é¡Œã€‚</li>
                             <li>å¼·åŒ–å¾Œç«¯ Apps Scriptï¼Œä½¿å…¶æ›´èƒ½æ‡‰å°æ¨™é¡Œä¸­çš„å¤šé¤˜ç©ºæ ¼ã€‚</li>
                             <li>å„ªåŒ–å‰ç«¯ä»‹é¢ï¼Œåœ¨è®€å–å¤±æ•—æ™‚æä¾›æ›´å‹å–„çš„æç¤ºã€‚</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.7</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>æ–°å¢å®¢è£½åŒ–éŒ¯èª¤æç¤ºè¦–çª—ï¼Œå–ä»£æ‰€æœ‰ `alert()`ï¼Œè§£æ±ºæ²™ç›’ç’°å¢ƒé™åˆ¶ã€‚</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.6</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>æ–°å¢ã€Œè®€å–ç´€éŒ„ã€åŠŸèƒ½ï¼Œå¯å¾ Google è©¦ç®—è¡¨è¼‰å…¥å·²å­˜æç¤ºè©ã€‚</li>
                            <li>æ›´æ–°å¾Œç«¯ Apps Script ä»¥æ”¯æ´è®€å–è³‡æ–™ã€‚</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.5</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>ä¿®å¾©ã€Œå„²å­˜è‡³è©¦ç®—è¡¨ã€åŠŸèƒ½å› å®‰å…¨é™åˆ¶ç„¡æ³•ä½¿ç”¨çš„å•é¡Œã€‚</li>
                            <li>ä»¥å®¢è£½åŒ–å½ˆå‡ºè¦–çª—å–ä»£ç€è¦½å™¨å…§å»ºçš„ prompt() åŠŸèƒ½ã€‚</li>
                             <li>å°‡ã€Œå„²å­˜ã€æŒ‰éˆ•ç§»è‡³ã€Œè¤‡è£½ã€æŒ‰éˆ•å³å´ã€‚</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.4</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>ç‚ºã€Œå„²å­˜è‡³ Google è©¦ç®—è¡¨ã€åŠŸèƒ½æ–°å¢è©³ç´°çš„éŒ¯èª¤è¨ºæ–·æ©Ÿåˆ¶ã€‚</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.3</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>æ–°å¢ã€Œå„²å­˜è‡³ Google è©¦ç®—è¡¨ã€åŠŸèƒ½ã€‚</li>
                        </ul>
                    </li>
                    <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.2</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>æ–°å¢ã€Œç‰ˆæœ¬æ›´æ–°æ—¥èªŒã€å½ˆå‡ºå¼è¦–çª—ã€‚</li>
                        </ul>
                    </li>
                     <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.1</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>æ–°å¢ã€Œå…¨éƒ¨æ¸…é™¤ã€æŒ‰éˆ•ï¼Œå¯ä¸€éµæ¸…ç©ºæ‰€æœ‰è¼¸å…¥æ¡†ã€‚</li>
                        </ul>
                    </li>
                     <li>
                        <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">v1.0</span>
                        <ul class="list-disc list-inside mt-2 pl-4 space-y-1">
                            <li>PARTS æç¤ºè©ç”¢ç”Ÿå™¨åˆå§‹ç‰ˆæœ¬ã€‚</li>
                            <li>æ ¸å¿ƒåŠŸèƒ½ï¼šPARTS æ¨¡å‹è¼¸å…¥ã€Gemini å„ªåŒ–æç¤ºè©ã€è¤‡è£½çµæœã€‚</li>
                            <li>æ·±æ·ºè‰²ä¸»é¡Œåˆ‡æ›ã€‚</li>
                            <li>å¯æ”¶åˆçš„æ•™å­¸ç¯„ä¾‹åº«ã€‚</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal for Prompt Name -->
    <div id="prompt-name-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm hidden">
        <div class="modal-enter bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm m-4">
            <div class="p-6 text-center">
                <h3 class="mb-5 text-lg font-normal text-gray-600 dark:text-gray-300">è«‹ç‚ºé€™çµ„æç¤ºè©å‘½å</h3>
                <input type="text" id="prompt-name-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="ä¾‹å¦‚ï¼šåœ‹èªä¿®è¾­å­¸ç¿’å–®" required>
                <div class="mt-6 flex justify-center gap-4">
                    <button id="cancel-save-btn" type="button" class="py-2.5 px-5 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-purple-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">å–æ¶ˆ</button>
                    <button id="confirm-save-btn" type="button" class="text-white bg-purple-600 hover:bg-purple-800 focus:ring-4 focus:outline-none focus:ring-purple-300 dark:focus:ring-purple-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for Loading History -->
    <div id="history-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm hidden">
        <div class="modal-enter bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl m-4 flex flex-col">
            <div class="flex justify-between items-center p-5 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">è®€å–å·²å­˜æç¤ºè©</h3>
                <button type="button" id="close-history-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 dark:hover:bg-gray-600 dark:hover:text-white rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div id="history-list" class="p-6 space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar">
                <!-- History items will be injected here -->
                <div id="history-loader" class="flex items-center justify-center py-10">
                    <svg class="animate-spin h-8 w-8 text-purple-500 dark:text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="ml-4 text-gray-600 dark:text-gray-300">æ­£åœ¨å¾ Google è©¦ç®—è¡¨è®€å–ç´€éŒ„...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Custom Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm hidden">
        <div class="modal-enter bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm m-4">
            <div class="p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-gray-700">
                    <svg class="h-6 w-6 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                </div>
                <h3 class="mt-5 text-lg font-medium text-gray-900 dark:text-white">ç™¼ç”ŸéŒ¯èª¤</h3>
                <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                    <p id="alert-message">é€™è£¡æœƒé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ã€‚</p>
                </div>
                <div class="mt-6">
                    <button id="close-alert-btn" type="button" class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-purple-600 text-base font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:text-sm">
                        çŸ¥é“äº†
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // This event listener ensures that the script runs only after the entire HTML document has been loaded and parsed.
        document.addEventListener('DOMContentLoaded', () => {
            
            // ===================================
            // THEME HANDLING SCRIPT
            // ===================================
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
            const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

            const updateThemeIcons = () => {
                if (document.documentElement.classList.contains('dark')) {
                    themeToggleLightIcon.classList.remove('hidden');
                    themeToggleDarkIcon.classList.add('hidden');
                } else {
                    themeToggleLightIcon.classList.add('hidden');
                    themeToggleDarkIcon.classList.remove('hidden');
                }
            };

            // Run on initial page load
            updateThemeIcons();

            themeToggleBtn.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                localStorage.setItem('color-theme', currentTheme);
                updateThemeIcons();
            });

            // ===================================
            // ALERT MODAL SCRIPT
            // ===================================
            const alertModal = document.getElementById('alert-modal');
            const alertMessageEl = document.getElementById('alert-message');
            const closeAlertBtn = document.getElementById('close-alert-btn');

            const showAlert = (message) => {
                // Using \n for newlines in JS strings; convert to <br> for HTML
                alertMessageEl.innerHTML = message.replace(/\n/g, '<br>');
                alertModal.classList.remove('hidden');
            };

            const hideAlert = () => {
                alertModal.classList.add('modal-leave');
                setTimeout(() => {
                    alertModal.classList.add('hidden');
                    alertModal.classList.remove('modal-leave');
                }, 300);
            };

            closeAlertBtn.addEventListener('click', hideAlert);
            alertModal.addEventListener('click', (event) => {
                if(event.target === alertModal) {
                    hideAlert();
                }
            });


            // ===================================
            // VERSION MODAL SCRIPT
            // ===================================
            const versionBtn = document.getElementById('version-btn');
            const versionModal = document.getElementById('version-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');

            const showVersionModal = () => versionModal.classList.remove('hidden');
            const hideVersionModal = () => {
                versionModal.classList.add('modal-leave');
                setTimeout(() => {
                    versionModal.classList.add('hidden');
                    versionModal.classList.remove('modal-leave');
                }, 300); // Match animation duration
            };

            versionBtn.addEventListener('click', showVersionModal);
            closeModalBtn.addEventListener('click', hideVersionModal);
            versionModal.addEventListener('click', (event) => {
                if (event.target === versionModal) {
                    hideVersionModal();
                }
            });
            
            // ===================================
            // PROMPT NAME MODAL SCRIPT
            // ===================================
            const promptNameModal = document.getElementById('prompt-name-modal');
            const promptNameInput = document.getElementById('prompt-name-input');
            const confirmSaveBtn = document.getElementById('confirm-save-btn');
            const cancelSaveBtn = document.getElementById('cancel-save-btn');

            const showPromptNameModal = () => {
                promptNameInput.value = ''; // Clear previous input
                promptNameModal.classList.remove('hidden');
                promptNameInput.focus();
            };
            const hidePromptNameModal = () => {
                promptNameModal.classList.add('modal-leave');
                 setTimeout(() => {
                    promptNameModal.classList.add('hidden');
                    promptNameModal.classList.remove('modal-leave');
                }, 300);
            };

            cancelSaveBtn.addEventListener('click', hidePromptNameModal);
            promptNameModal.addEventListener('click', (event) => {
                if (event.target === promptNameModal) {
                    hidePromptNameModal();
                }
            });


            // ===================================
            // EXAMPLE LIBRARY TOGGLE SCRIPT
            // ===================================
            const exampleToggleBtn = document.getElementById('example-toggle-btn');
            const exampleLibrarySection = document.getElementById('example-library');

            exampleToggleBtn.addEventListener('click', () => {
                const isHidden = exampleLibrarySection.classList.toggle('hidden');
                if (!isHidden) {
                    exampleLibrarySection.classList.add('fade-in');
                }
            });
            
            // ===================================
            // EXAMPLE LIBRARY SCRIPT
            // ===================================
            const examples = [
                {
                    name: "åœ‹èªï¼šæ•…äº‹çºŒå¯«",
                    persona: "ä½ æ˜¯ä¸€ä½å……æ»¿å‰µæ„ã€æ“…é•·å¼•å°å­¸ç”Ÿæƒ³åƒåŠ›çš„åœ‹å°ä¸­å¹´ç´šåœ‹èªè€å¸«ã€‚",
                    act: "è«‹è¨­è¨ˆä¸€å€‹æ•…äº‹çºŒå¯«çš„å­¸ç¿’æ´»å‹•ã€‚",
                    recipient: "é€™ä»½æ´»å‹•æ˜¯ç‚ºåœ‹å°ä¸‰å¹´ç´šçš„å­¸ç”Ÿè¨­è¨ˆçš„ï¼Œä»–å€‘çš„æƒ³åƒåŠ›è±å¯Œä½†å¯«ä½œçµæ§‹èƒ½åŠ›å°šå¾…åŠ å¼·ã€‚",
                    topic: "æ•…äº‹çš„é–‹é ­æ˜¯ï¼šã€åœ¨ä¸€å€‹ä¸‹è‘—æš´é›¨çš„å¤œæ™šï¼Œå°æ˜è½åˆ°é–£æ¨“å‚³ä¾†ä¸€é™£å¥‡æ€ªçš„æŠ“æ‰’è²...ã€ï¼Œè«‹å¼•å°å­¸ç”Ÿæ€è€ƒæ¥ä¸‹ä¾†å¯èƒ½ç™¼ç”Ÿçš„ä¸‰ç¨®ä¸åŒæƒ…ç¯€ã€‚",
                    structure: "è«‹ç”¨æ¢åˆ—å¼å‘ˆç¾ä¸‰ç¨®æƒ…ç¯€çš„ç™¼å±•å¤§ç¶±ï¼Œæ¯å€‹å¤§ç¶±åŒ…å«ã€ä¸»è§’çš„ç™¼ç¾ã€ã€ã€é‡åˆ°çš„æŒ‘æˆ°ã€ã€ã€æ„å¤–çš„ç»“å±€ã€ä¸‰å€‹éƒ¨åˆ†ã€‚"
                },
                {
                    name: "æ•¸å­¸ï¼šç”Ÿæ´»æ‡‰ç”¨é¡Œ",
                    persona: "ä½ æ˜¯ä¸€ä½åœ‹å°é«˜å¹´ç´šæ•¸å­¸è€å¸«ï¼Œæ“…é•·å°‡æ•¸å­¸èˆ‡ç”Ÿæ´»æƒ…å¢ƒçµåˆã€‚",
                    act: "è«‹è¨­è¨ˆä¸€é“å…©æ­¥é©Ÿçš„æ•¸å­¸æ‡‰ç”¨é¡Œã€‚",
                    recipient: "é€™é“é¡Œç›®æ˜¯çµ¦åœ‹å°äº”å¹´ç´šå­¸ç”Ÿç·´ç¿’çš„ï¼Œä»–å€‘å·²ç¶“å­¸æœƒäº†æ•´æ•¸çš„å››å‰‡é‹ç®—ã€‚",
                    topic: "æƒ…å¢ƒè¨­å®šç‚ºç­ç´šåœ’éŠæœƒï¼Œç­ä¸Šè³ºäº† 1000 å…ƒï¼Œè²·äº† 15 æ¯å–®åƒ¹ 30 å…ƒçš„é£²æ–™çŠ’è³åŒå­¸å¾Œï¼Œå‰©ä¸‹çš„éŒ¢è¦å¹³åˆ†çµ¦ç­ä¸Š 25 ä½åŒå­¸ã€‚",
                    structure: "è«‹å…ˆå¯«å‡ºå®Œæ•´çš„é¡Œç›®ï¼Œç„¶å¾Œåœ¨ä¸‹æ–¹åˆ—å‡ºè¨ˆç®—æ­¥é©Ÿçš„å¼•å°å•é¡Œï¼Œæœ€å¾Œé™„ä¸Šæ­£ç¢ºç­”æ¡ˆèˆ‡ç®—å¼ã€‚"
                },
                {
                    name: "è‡ªç„¶ï¼šæ¤ç‰©è§€å¯Ÿ",
                    persona: "ä½ æ˜¯ä¸€ä½å°è‡ªç„¶ç”Ÿæ…‹å……æ»¿ç†±æƒ…çš„åœ‹å°è‡ªç„¶è€å¸«ã€‚",
                    act: "è«‹è¨­è¨ˆä¸€ä»½æ¤ç‰©è§€å¯Ÿç´€éŒ„å–®ã€‚",
                    recipient: "é€™ä»½ç´€éŒ„å–®æ˜¯çµ¦åœ‹å°å››å¹´ç´šå­¸ç”Ÿåœ¨æ ¡åœ’é€²è¡Œè‡ªç„¶è§€å¯Ÿæ™‚ä½¿ç”¨çš„ã€‚",
                    topic: "è§€å¯Ÿå°è±¡æ˜¯æ ¡åœ’è£¡çš„æ¦•æ¨¹ã€‚ç´€éŒ„å–®éœ€è¦å¼•å°å­¸ç”Ÿè§€å¯Ÿè‘‰å­ã€æ¨¹å¹¹ã€æ°£æ ¹çš„ç‰¹å¾µã€‚",
                    structure: "è«‹ä»¥è¡¨æ ¼å½¢å¼å‘ˆç¾ï¼Œæ¬„ä½åŒ…å«ã€Œè§€å¯Ÿé …ç›®ã€ï¼ˆå¦‚ï¼šè‘‰å­å½¢ç‹€ã€æ¨¹å¹¹é¡è‰²ã€æ°£æ ¹æ•¸é‡ï¼‰ã€ã€Œè§€å¯Ÿç´€éŒ„ã€ï¼ˆè®“å­¸ç”Ÿå¡«å¯«ï¼‰ã€ã€Œç¹ªåœ–å€ã€ï¼ˆè®“å­¸ç”Ÿç•«ä¸‹ä¾†ï¼‰ã€‚"
                },
                {
                    name: "ç¤¾æœƒï¼šæ­·å²äººç‰©",
                    persona: "ä½ æ˜¯ä¸€ä½æ“…é•·èªªæ•…äº‹çš„åœ‹å°ç¤¾æœƒè€å¸«ã€‚",
                    act: "è«‹ç”¨ç”Ÿå‹•æœ‰è¶£çš„æ–¹å¼ï¼Œä»‹ç´¹é„­æˆåŠŸçš„æ•…äº‹ã€‚",
                    recipient: "è½çœ¾æ˜¯åœ‹å°å››å¹´ç´šçš„å­¸ç”Ÿï¼Œä»–å€‘å°æ­·å²æ•…äº‹æ„Ÿåˆ°å¥½å¥‡ã€‚",
                    topic: "ä»‹ç´¹å…§å®¹éœ€åŒ…å«é„­æˆåŠŸæ˜¯èª°ã€ä»–ç‚ºä»€éº¼è¦ä¾†å°ç£ï¼Œä»¥åŠä»–å°å°ç£çš„å½±éŸ¿ã€‚",
                    structure: "è«‹ç”¨ç¬¬ä¸€äººç¨±ã€æˆ‘ã€ï¼Œä¹Ÿå°±æ˜¯ä½ æ‰®æ¼”é„­æˆåŠŸçš„å£å»ä¾†æ•˜è¿°ã€‚å…§å®¹åˆ†æˆä¸‰æ®µï¼Œæ¯æ®µä¸è¶…é150å­—ã€‚"
                },
                 {
                    name: "ç¶œåˆï¼šç­ç´šæ´»å‹•",
                    persona: "ä½ æ˜¯ä¸€ä½æœ‰è€å¿ƒä¸”å–„æ–¼åœ˜éšŠåˆä½œçš„åœ‹å°ç­ç´šå°å¸«ã€‚",
                    act: "è«‹è¦åŠƒä¸€å€‹å¢é€²ç­ç´šå‘å¿ƒåŠ›çš„æœŸæœ«åŒæ¨‚æœƒæ´»å‹•ã€‚",
                    recipient: "æ´»å‹•å°è±¡æ˜¯åœ‹å°å…­å¹´ç´šçš„ç•¢æ¥­ç­å­¸ç”Ÿã€‚",
                    topic: "æ´»å‹•ç›®æ¨™æ˜¯è®“å­¸ç”Ÿåœ¨ç•¢æ¥­å‰ç•™ä¸‹ç¾å¥½å›æ†¶ï¼Œä¸¦æ„Ÿè¬è€å¸«èˆ‡åŒå­¸ã€‚æ´»å‹•æ™‚é–“ç‚ºä¸€ç¯€èª²40åˆ†é˜ã€‚",
                    structure: "è«‹æä¾›ä¸€ä»½æ´»å‹•æµç¨‹è¡¨ï¼ŒåŒ…å«æ™‚é–“åˆ†é…ã€æ´»å‹•åç¨±ã€æ´»å‹•èªªæ˜ã€ä»¥åŠéœ€è¦æº–å‚™çš„é“å…·ã€‚"
                }
            ];

            const exampleButtonsContainer = document.getElementById('example-buttons-container');
            const personaEl = document.getElementById('persona');
            const actEl = document.getElementById('act');
            const recipientEl = document.getElementById('recipient');
            const topicEl = document.getElementById('topic');
            const structureEl = document.getElementById('structure');

            examples.forEach(example => {
                const button = document.createElement('button');
                button.className = 'example-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 py-2 px-4 rounded-lg font-semibold shadow-sm hover:bg-gray-300 dark:hover:bg-gray-600';
                button.textContent = example.name;
                button.addEventListener('click', () => {
                    // Reset the view by hiding the output section
                    document.getElementById('output-section').classList.add('hidden');

                    personaEl.value = example.persona;
                    actEl.value = example.act;
                    recipientEl.value = example.recipient;
                    topicEl.value = example.topic;
                    structureEl.value = example.structure;
                });
                exampleButtonsContainer.appendChild(button);
            });

            // ===================================
            // MAIN APP SCRIPT
            // ===================================
            // !!! IMPORTANT !!! PASTE YOUR WEB APP URL HERE
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzNEE5foyrgMPSOqsvK50fVgO8npbmV9V6UIwrVuB7myJSy7Rpv9x8vZda7Sc4wRbQr/exec";

            const generateBtn = document.getElementById('generate-btn');
            const clearBtn = document.getElementById('clear-btn');
            const saveSheetBtn = document.getElementById('save-sheet-btn');
            const outputSection = document.getElementById('output-section');
            const originalPromptEl = document.getElementById('original-prompt');
            const optimizedPromptEl = document.getElementById('optimized-prompt');
            const loader = document.getElementById('loader');
            const copyBtn = document.getElementById('copy-btn');
            const loadHistoryBtn = document.getElementById('load-history-btn');


            clearBtn.addEventListener('click', () => {
                personaEl.value = '';
                actEl.value = '';
                recipientEl.value = '';
                topicEl.value = '';
                structureEl.value = '';
                outputSection.classList.add('hidden');
                saveSheetBtn.classList.add('hidden');
            });


            generateBtn.addEventListener('click', async () => {
                const persona = personaEl.value.trim();
                const act = actEl.value.trim();
                const recipient = recipientEl.value.trim();
                const topic = topicEl.value.trim();
                const structure = structureEl.value.trim();
                const parts = [
                    persona ? `è§’è‰²è¨­å®š: ${persona}` : '',
                    act ? `ä»»å‹™æŒ‡ä»¤: ${act}` : '',
                    recipient ? `ç›®æ¨™å°è±¡: ${recipient}` : '',
                    topic ? `ä¸»é¡Œå…§å®¹: ${topic}` : '',
                    structure ? `æ ¼å¼è¦æ±‚: ${structure}` : ''
                ];
                const originalPrompt = parts.filter(p => p).join('\n\n');

                if (!originalPrompt) {
                    showAlert('è«‹è‡³å°‘å¡«å¯«ä¸€å€‹æ¬„ä½ï¼');
                    return;
                }

                outputSection.classList.remove('hidden');
                outputSection.classList.add('fade-in');
                originalPromptEl.textContent = originalPrompt;
                optimizedPromptEl.textContent = '';
                copyBtn.classList.add('hidden');
                saveSheetBtn.classList.add('hidden');
                loader.style.display = 'flex';
                
                const optimizationSystemPrompt = "ä½ æ˜¯ä¸€ä½æç¤ºè©å·¥ç¨‹å°ˆå®¶ (Prompt Engineering Expert)ã€‚ä½ çš„ä»»å‹™æ˜¯å°‡ä½¿ç”¨è€…æä¾›çš„ã€ç”±å¤šå€‹éƒ¨åˆ†çµ„åˆè€Œæˆçš„åˆæ­¥æç¤ºè©ï¼Œå„ªåŒ–ä¸¦æ•´åˆæˆä¸€å€‹å–®ä¸€ã€æµæš¢ã€æ¸…æ™°ä¸”é«˜æ•ˆçš„å®Œæ•´æç¤ºè©ã€‚ä½ æ‡‰è©²ä¿ç•™æ‰€æœ‰é—œéµè¨Šæ¯å’Œæ ¸å¿ƒæ„åœ–ï¼Œä½†è¦ä»¥æ›´å°ˆæ¥­ã€æ›´çµæ§‹åŒ–çš„æ–¹å¼é‡æ–°çµ„ç¹”èªè¨€ï¼Œç¢ºä¿AIèƒ½å¤ æº–ç¢ºç†è§£ä¸¦ç”¢å‡ºæœ€ä½³çµæœã€‚ç›´æ¥å›å‚³å„ªåŒ–å¾Œçš„æç¤ºè©å³å¯ï¼Œä¸éœ€è¦ä»»ä½•é¡å¤–çš„å‰è¨€æˆ–çµèªã€‚";
                const userQueryForApi = `è«‹å„ªåŒ–ä»¥ä¸‹é€™å€‹ç”±PARTSæ¨¡å‹å„éƒ¨åˆ†çµ„åˆè€Œæˆçš„åˆæ­¥æç¤ºè©ï¼Œå°‡å…¶æ”¹å¯«æˆä¸€å€‹å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ã€é«˜å“è³ªçš„å–®ä¸€å®Œæ•´æç¤ºè©ã€‚\n\n---åˆæ­¥æç¤ºè©---\n${originalPrompt}`;

                try {
                    const optimizedText = await callGeminiApiWithBackoff(optimizationSystemPrompt, userQueryForApi);
                    optimizedPromptEl.textContent = optimizedText;
                    if (optimizedText && !optimizedText.startsWith("æŠ±æ­‰")) {
                        copyBtn.classList.remove('hidden'); 
                        saveSheetBtn.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('API Error:', error);
                    optimizedPromptEl.textContent = `æŠ±æ­‰ï¼Œå„ªåŒ–éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤è¨Šæ¯: ${error.message}`;
                } finally {
                    loader.style.display = 'none';
                }
            });
            
            // New logic to handle custom modal for saving
            saveSheetBtn.addEventListener('click', () => {
                if (SCRIPT_URL.includes("è«‹åœ¨é€™è£¡è²¼ä¸Š")) {
                    showAlert("éŒ¯èª¤ï¼šæ‚¨å°šæœªåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šæ‚¨çš„ Google Apps Script ç¶²å€ï¼è«‹éµå¾ªè¨­å®šæŒ‡å—å®Œæˆè¨­å®šã€‚");
                    return;
                }
                showPromptNameModal();
            });
            
            confirmSaveBtn.addEventListener('click', () => {
                const promptName = promptNameInput.value.trim();
                 if (!promptName) {
                    promptNameInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    promptNameInput.placeholder = "è«‹å‹™å¿…ç‚ºæç¤ºè©å‘½åï¼";
                    return;
                }
                promptNameInput.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                promptNameInput.placeholder = "ä¾‹å¦‚ï¼šåœ‹èªä¿®è¾­å­¸ç¿’å–®";
                hidePromptNameModal();
                executeSave(promptName);
            });

            async function executeSave(promptName) {
                const originalButtonText = saveSheetBtn.innerHTML;
                saveSheetBtn.disabled = true;
                saveSheetBtn.innerHTML = `<span>å„²å­˜ä¸­...</span>`;

                const dataToSave = {
                    promptName: promptName,
                    persona: personaEl.value,
                    act: actEl.value,
                    recipient: recipientEl.value,
                    topic: topicEl.value,
                    structure: structureEl.value,
                    optimizedPrompt: optimizedPromptEl.textContent
                };

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataToSave)
                    });

                    saveSheetBtn.innerHTML = `<span>å„²å­˜æˆåŠŸï¼</span>`;
                    saveSheetBtn.classList.add('bg-blue-600');
                    setTimeout(() => {
                        saveSheetBtn.innerHTML = originalButtonText;
                        saveSheetBtn.disabled = false;
                        saveSheetBtn.classList.remove('bg-blue-600');
                    }, 2000);

                } catch (err) {
                    console.error("Error saving to sheet:", err);
                    saveSheetBtn.innerHTML = `<span>å„²å­˜å¤±æ•—</span>`;
                    saveSheetBtn.classList.add('bg-red-600');
                     setTimeout(() => {
                        saveSheetBtn.innerHTML = originalButtonText;
                        saveSheetBtn.disabled = false;
                        saveSheetBtn.classList.remove('bg-red-600');
                    }, 3000);
                    showAlert(`å„²å­˜å¤±æ•—ï¼\n\né€™é€šå¸¸æ˜¯ç¶²è·¯é€£ç·šæˆ– CORS è·¨åŸŸæ”¿ç­–å•é¡Œã€‚\n\n1. è«‹ç¢ºèªæ‚¨çš„ç¶²è·¯é€£ç·šæ­£å¸¸ã€‚\n2. è«‹å†æ¬¡æª¢æŸ¥æ‚¨çš„ Apps Script æ˜¯å¦å·²éƒ¨ç½²ç‚ºã€Œä»»ä½•äººã€çš†å¯å­˜å–ã€‚\n3. è«‹æ‰“é–‹ç€è¦½å™¨ä¸»æ§å° (F12) æŸ¥çœ‹è©³ç´°çš„ç´…è‰²éŒ¯èª¤è¨Šæ¯ã€‚\n\néŒ¯èª¤è©³æƒ…: ${err.message}`);
                }
            }
            
            // ===================================
            // HISTORY MODAL SCRIPT
            // ===================================
            const historyModal = document.getElementById('history-modal');
            const closeHistoryModalBtn = document.getElementById('close-history-modal-btn');
            const historyList = document.getElementById('history-list');
            const historyLoader = document.getElementById('history-loader');

            const showHistoryModal = () => historyModal.classList.remove('hidden');
            const hideHistoryModal = () => {
                historyModal.classList.add('modal-leave');
                setTimeout(() => {
                    historyModal.classList.add('hidden');
                    historyModal.classList.remove('modal-leave');
                }, 300);
            };
            
            loadHistoryBtn.addEventListener('click', async () => {
                if (SCRIPT_URL.includes("è«‹åœ¨é€™è£¡è²¼ä¸Š")) {
                    showAlert("éŒ¯èª¤ï¼šæ‚¨å°šæœªåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šæ‚¨çš„ Google Apps Script ç¶²å€ï¼");
                    return;
                }
                
                showHistoryModal();
                historyLoader.classList.remove('hidden');
                historyList.innerHTML = ''; // Clear previous list but keep the loader
                historyList.appendChild(historyLoader);

                try {
                    // Use GET to fetch data
                    const response = await fetch(SCRIPT_URL);
                    if (!response.ok) {
                        throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();
                    
                    historyLoader.classList.add('hidden');

                    if (data && data.length > 0) {
                        // Data is received in reverse chronological order from script
                        data.forEach(item => {
                            const div = document.createElement('div');
                            const promptName = item.promptName || 'ï¼ˆè®€å–å¤±æ•—ï¼šè«‹æª¢æŸ¥è©¦ç®—è¡¨æ¨™é¡Œï¼‰';
                            
                            div.className = "p-4 border border-gray-200 dark:border-gray-700 rounded-lg transition-colors";
                             if(item.promptName){
                                div.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700', 'cursor-pointer');
                            } else {
                                div.classList.add('cursor-not-allowed', 'opacity-60');
                            }

                            div.innerHTML = `
                                <h4 class="font-bold text-md text-purple-600 dark:text-purple-400">${promptName}</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 truncate">
                                    ${item.optimizedPrompt || 'ï¼ˆç„¡å„ªåŒ–å¾Œæç¤ºè©ï¼‰'}
                                </p>
                            `;

                            if (item.promptName) {
                                div.addEventListener('click', () => {
                                    personaEl.value = item.persona || '';
                                    actEl.value = item.act || '';
                                    recipientEl.value = item.recipient || '';
                                    topicEl.value = item.topic || '';
                                    structureEl.value = item.structure || '';

                                    // Also populate the output section
                                    const originalPrompt = [
                                        item.persona ? `è§’è‰²è¨­å®š: ${item.persona}` : '',
                                        item.act ? `ä»»å‹™æŒ‡ä»¤: ${item.act}` : '',
                                        item.recipient ? `ç›®æ¨™å°è±¡: ${item.recipient}` : '',
                                        item.topic ? `ä¸»é¡Œå…§å®¹: ${item.topic}` : '',
                                        item.structure ? `æ ¼å¼è¦æ±‚: ${item.structure}` : ''
                                    ].filter(p => p).join('\n\n');

                                    outputSection.classList.remove('hidden');
                                    originalPromptEl.textContent = originalPrompt;
                                    optimizedPromptEl.textContent = item.optimizedPrompt || '';
                                    if (item.optimizedPrompt) {
                                        copyBtn.classList.remove('hidden');
                                        saveSheetBtn.classList.remove('hidden');
                                    } else {
                                        copyBtn.classList.add('hidden');
                                        saveSheetBtn.classList.add('hidden');
                                    }
                                    loader.style.display = 'none';
                                    
                                    hideHistoryModal();
                                });
                            }
                            historyList.appendChild(div);
                        });
                    } else {
                        historyList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">æ‚¨çš„è©¦ç®—è¡¨ä¸­æ²’æœ‰ä»»ä½•å·²å­˜ç´€éŒ„ã€‚</p>`;
                    }

                } catch (error) {
                    console.error("Error fetching history:", error);
                    historyLoader.classList.add('hidden');
                    historyList.innerHTML = `<p class="text-center text-red-500">è®€å–ç´€éŒ„å¤±æ•—ï¼<br>è«‹æª¢æŸ¥ Apps Script éƒ¨ç½²èˆ‡æ¬Šé™è¨­å®šï¼Œæˆ–æŸ¥çœ‹ä¸»æ§å°éŒ¯èª¤ã€‚</p>`;
                }
            });
            
            closeHistoryModalBtn.addEventListener('click', hideHistoryModal);
            historyModal.addEventListener('click', (event) => {
                if (event.target === historyModal) {
                    hideHistoryModal();
                }
            });


            copyBtn.addEventListener('click', () => {
                const textToCopy = optimizedPromptEl.textContent;
                if (!textToCopy) return;
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = textToCopy;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                const originalButtonContent = copyBtn.innerHTML;
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
                        <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"></path>
                    </svg>
                    <span>å·²è¤‡è£½ï¼</span>
                `;
                const btnClasses = ['bg-green-500', 'dark:bg-green-600', 'hover:bg-green-600', 'dark:hover:bg-green-700'];
                copyBtn.classList.add(...btnClasses);
                setTimeout(() => {
                    copyBtn.innerHTML = originalButtonContent;
                    copyBtn.classList.remove(...btnClasses);
                }, 2000);
            });
            
            async function callGeminiApiWithBackoff(systemPrompt, userQuery) {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }] };
                if (systemPrompt) {
                    payload.systemInstruction = { parts: [{ text: systemPrompt }] };
                }
                let attempts = 0;
                const maxAttempts = 5;
                let delay = 1000;
                while (attempts < maxAttempts) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const errorBody = await response.text();
                            throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);
                        }
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            console.warn("API response was successful but contained no text.", result);
                            return "å„ªåŒ–å¾Œçš„å›æ‡‰ç‚ºç©ºï¼Œè«‹å˜—è©¦èª¿æ•´æ‚¨çš„è¼¸å…¥ã€‚";
                        }
                    } catch (error) {
                        attempts++;
                        console.warn(`API call attempt ${attempts} failed. Retrying in ${delay}ms...`, error);
                        if (attempts >= maxAttempts) {
                            throw new Error("å·²é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸ï¼ŒAPI è«‹æ±‚å¤±æ•—ã€‚");
                        }
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
            }
        });
    </script>
</body>
</html>

